# To add with: init mapping/all
# DIR_SCRIPTS=...
# SUBDIR+=...
# FILE_FASTA_MIRNA=...
# REFERENCE_MIRNA=...

# Prepare variables
DIR_MAPPING_MIRNA=GenomeMapping
DIR_FASTA_MIRNA=$(DIR_MAPPING_MIRNA)/fasta

TARGETS_BLAST_MIRNA=$(SUBDIR)/$(basename $(notdir $(FILE_FASTA_MIRNA))).out
TARGET_SUMMARY_MIRNA=$(basename $(TARGETS_BLAST_MIRNA))_summary.txt
TARGET_FASTA_MIRNA=$(DIR_FASTA_MIRNA)/$(basename $(notdir $(TARGETS_BLAST_MIRNA))).fasta
TARGET_FASTA_UNMAPPED_MIRNA=$(basename $(TARGETS_BLAST_MIRNA))_unmapped.fasta
TARGET_FASTQ_UNMAPPED_MIRNA=$(basename $(TARGETS_BLAST_MIRNA))_unmapped.fastq

TOOLS_ALIGNMENT=$(DIR_SCRIPTS)/Alignment-Tools/Alignment-Tools
TOOLS_ALIGNMENT+= $(DIR_SCRIPTS)/Alignment-Tools/Utility/blastn
TOOLS_ALIGNMENT+= $(DIR_SCRIPTS)/Alignment-Tools/Template/Makefile_blastn_Template

TOOLS_BLAST_ANALYSIS=$(DIR_SCRIPTS)/Utility/BlastAnalysis.py 
TOOLS_BLAST_ANALYSIS+= $(DIR_SCRIPTS)/Utility/BlastParser.py
TOOLS_BLAST_ANALYSIS+= $(DIR_SCRIPTS)/Utility/getFasta.py

PERL=$(shell which perl)

# Alignment
.PHONY: mapping-miRNA
mapping-miRNA: $(TARGET_SUMMARY_MIRNA) $(TARGET_FASTA_MIRNA) $(TARGET_FASTQ_UNMAPPED_MIRNA)

$(TARGET_FASTQ_UNMAPPED_MIRNA): $(TARGET_FASTA_MIRNA) $(PERL) $(DIR_SCRIPTS)/Utility/fasta_to_fastq.pl
	$(PERL) $(DIR_SCRIPTS)/Utility/fasta_to_fastq.pl $< | sed 's/@ P/@P/g' > $@

$(TARGET_FASTA_UNMAPPED_MIRNA): $(TOOLS_BLAST_ANALYSIS) $(TARGETS_BLAST_MIRNA)
	cd $(SUBDIR); $< $(notdir $(TARGETS_BLAST_MIRNA)) id | grep -v no_match | cut -f3- | $(DIR_SCRIPTS)/Utility/getFasta.py $(FILE_FASTA_MIRNA) not-match > $(notdir $@)

$(TARGET_FASTA_MIRNA): $(TOOLS_BLAST_ANALYSIS) $(TARGETS_BLAST_MIRNA)
	mkdir -p $(DIR_FASTA_MIRNA)
	cd $(SUBDIR); $< $(notdir $(TARGETS_BLAST_MIRNA)) id | grep -v no_match | cut -f3- | $(DIR_SCRIPTS)/Utility/getFasta.py $(FILE_FASTA_MIRNA) match > $(notdir $@)
	ln -sf ../$(notdir $(SUBDIR))/$(notdir $@) $@

$(TARGET_SUMMARY_MIRNA): $(TARGETS_BLAST_MIRNA) $(TOOLS_BLAST_ANALYSIS)
	$(DIR_SCRIPTS)/Utility/BlastAnalysis.py $< summary > $@

$(TARGETS_BLAST_MIRNA): $(TOOLS_ALIGNMENT)
	mkdir -p $(SUBDIR)
	cd $(SUBDIR); $< init blastn $(FILE_FASTA_MIRNA) $(REFERENCE_MIRNA) "-evalue;0.01;-word_size;4;"
	$(MAKE) -C $(SUBDIR)
