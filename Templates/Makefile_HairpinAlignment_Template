# To add with init
#DIR_SCRIPTS=...
#FILE_UNIQUE_FASTA=...
#FILE_HAIRPIN_FASTA=...
#FILE_MATURE_FASTA=...

# Prepare variables
URL_MIRBASE=ftp://mirbase.org/pub/mirbase/CURRENT/database_files
DIR_RESULTS=HairpinsAlignment
DIR_META=$(DIR_RESULTS)/Meta
DIR_REFERENCE=$(DIR_RESULTS)/Reference
DIR_ALIGNMENT=$(DIR_RESULTS)/Alignment
DIR_HTML=$(DIR_RESULTS)/html-report

BASE_UNIQUE_FASTA=$(basename $(notdir $(FILE_UNIQUE_FASTA)))
FILE_MATURE=$(DIR_RESULTS)/mirna_mature.txt
FILE_MIRNA=$(DIR_RESULTS)/mirna.txt
FILE_PREMATURE=$(DIR_RESULTS)/mirna_pre_mature.txt

TOOL_BLASTDB=$(shell which makeblastdb)
TOOL_BLASTN=$(shell which blastn)
TOOLS_ALIGNMENT=$(DIR_SCRIPTS)/Alignment-Tools/Alignment-Tools
GCC=$(shell which g++)
TOOL_ALIGN=$(DIR_SCRIPTS)/Utility/miRNA_align

TARGET_PAIRS=$(DIR_RESULTS)/mirna_pairs.txt
TARGET_UNIQUE_FASTA=$(DIR_RESULTS)/$(BASE_UNIQUE_FASTA)_unique.fasta
TARGET_HAIRPIN_FASTA=$(DIR_REFERENCE)/$(notdir $(FILE_HAIRPIN_FASTA))
TARGET_MATURE_FASTA=$(DIR_REFERENCE)/$(notdir $(FILE_MATURE_FASTA))
TARGET_BLAST=$(DIR_RESULTS)/$(BASE_UNIQUE_FASTA)_hits.txt
TARGET_HTML=$(DIR_RESULTS)/index.html

# Start the analysis
.PHONY: hairpin-alignment
hairpin-alignment: $(TARGET_PAIRS) $(TARGET_BLAST) $(TARGET_HTML)

$(TARGET_HTML): $(TOOL_ALIGN) $(TARGET_UNIQUE_FASTA) $(TARGET_HAIRPIN_FASTA) $(TARGET_MATURE_FASTA) $(TARGET_BLAST) $(TARGET_PAIRS)
	mkdir -p $(DIR_HTML)
	cd $(DIR_RESULTS); $< $(notdir $(TARGET_UNIQUE_FASTA)) Reference/$(notdir $(TARGET_HAIRPIN_FASTA)) Reference/$(notdir $(TARGET_MATURE_FASTA)) $(notdir $(TARGET_BLAST)) $(notdir $(TARGET_PAIRS))

$(TOOL_ALIGN): $(TOOL_ALIGN).cpp
	$(GCC) -O3 -Wall $< -o $@

$(TARGET_BLAST): $(TOOLS_ALIGNMENT) $(TARGET_UNIQUE_FASTA) $(TARGET_HAIRPIN_FASTA)
	mkdir -p $(DIR_ALIGNMENT)
	cd $(DIR_ALIGNMENT); $< init blastn ../$(notdir $(TARGET_UNIQUE_FASTA)) ../../reference/$(notdir $(TARGET_HAIRPIN_FASTA)) "-outfmt;6;-evalue;0.001;-word_size;4;-num_threads;8"
	$(MAKE) -C $(DIR_ALIGNMENT)
	ln -sf $(notdir $(DIR_ALIGNMENT))/$(BASE_UNIQUE_FASTA)_unique.out $@

$(TARGET_HAIRPIN_FASTA): $(FILE_HAIRPIN_FASTA)
	mkdir -p $(DIR_REFERENCE)
	ln -sf ../../$< $@

$(TARGET_MATURE_FASTA): $(FILE_MATURE_FASTA)
	mkdir -p $(DIR_REFERENCE)
	ln -sf ../../$< $@

$(TARGET_UNIQUE_FASTA): $(FILE_UNIQUE_FASTA)
	sed 's/ PP_//g;s/Count: //g' $< > $@

$(TARGET_PAIRS): $(FILE_MATURE) $(FILE_MIRNA) $(FILE_PREMATURE)
	$(DIR_SCRIPTS)/Utility/getpairs.py $^ > $@

%.txt: 
	cd $(DIR_RESULTS); wget $(URL_MIRBASE)/$(notdir $@).gz
	gunzip -d $@.gz
