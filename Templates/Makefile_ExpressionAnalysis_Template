# To add with init
#DIR_SCRIPTS=...
#FILE_SUMMARY_EXPRESSION=...

# Prepare variables
DIR_EXPRESSION=ExpressionAnalysis
DIR_META_EXPRESSION=$(DIR_EXPRESSION)/Meta

TOOL_RSCRIPT=$(shell which Rscript)
TOOL_SUMMARY_ANALYSIS=$(DIR_SCRIPTS)/Utility/BlastSummaryAnalysis.py

# Prepare targets
TARGET_SUMMARY_EXPRESSION=$(DIR_EXPRESSION)/$(notdir $(FILE_SUMMARY_EXPRESSION))
TARGET_PROFILING_EXPRESSION=$(DIR_EXPRESSION)/$(basename $(notdir $(FILE_SUMMARY_EXPRESSION)))_profiling.tiff
TARGET_PIE_CHART_EXPRESSION=$(DIR_EXPRESSION)/$(basename $(notdir $(FILE_SUMMARY_EXPRESSION)))_pie_chart.tiff
TARGET_PIE_INTERMEDIATE_EXPRESSION=$(DIR_EXPRESSION)/$(basename $(notdir $(FILE_SUMMARY_EXPRESSION)))_pie_chart.txt

# Prepare directory structure
$(shell mkdir -p $(DIR_EXPRESSION))
$(shell mkdir -p $(DIR_META_EXPRESSION))

# Start analysis

.PHONY: expression
expression: $(TARGET_PROFILING_EXPRESSION) $(TARGET_PIE_CHART_EXPRESSION)

$(TARGET_PIE_CHART_EXPRESSION): $(TARGET_PIE_INTERMEDIATE_EXPRESSION)
	$(TOOL_RSCRIPT) $(DIR_SCRIPTS)/Rscripts/PieChart.R tiff $< $(basename $@)

$(TARGET_PIE_INTERMEDIATE_EXPRESSION): $(FILE_SUMMARY_EXPRESSION) $(TOOL_SUMMARY_ANALYSIS)
	cat $< | $(TOOL_SUMMARY_ANALYSIS) | sort -nr -k2 | head -n15 > $@
	echo -e "others\t$$(cat $< | $(TOOL_SUMMARY_ANALYSIS) | sort -nr -k2 | tail -n+16 | awk '{sum+=$$2}END{print sum}')" >> $@

$(TARGET_PROFILING_EXPRESSION): $(TARGET_SUMMARY_EXPRESSION)
	$(TOOL_RSCRIPT) $(DIR_SCRIPTS)/Rscripts/Profiling.R tiff $< $(basename $@)
	$(TOOL_RSCRIPT) --version &> $(DIR_META_EXPRESSION)/Rscript.txt

$(TARGET_SUMMARY_EXPRESSION): $(FILE_SUMMARY_EXPRESSION)
	cut -f2,3 $< | sort -nr -k2 > $@
