# To add with init
#DIR_SCRIPTS=...
#FILES_CONTRIB+=...
#FILE_SOURCE_FASTA_CONTRIB=...

DIR_SOURCE_FASTA_CONTRIB=GenomeMapping/fasta
DIR_RESULTS_CONTRIB=ContributionAnalysis
DIR_FASTA_CONTRIB=$(DIR_RESULTS_CONTRIB)/Fasta
DIR_INTERMEDIATE_CONTRIB=$(DIR_RESULTS_CONTRIB)/Intermediate

TARGETS_FASTA_CONTRIB=$(addprefix $(DIR_FASTA_CONTRIB)/, $(FILES_CONTRIB))
TARGET_COUNT_CONTRIB=$(DIR_RESULTS_CONTRIB)/count.txt
TARGETS_INTERMEDIATE_CONTRIB=$(addprefix $(DIR_RESULTS_CONTRIB)/, $(addsuffix _Contribution.txt, $(basename $(FILES_CONTRIB))))
TARGET_SOURCE_INTERMEDIATE_CONTRIB=$(DIR_INTERMEDIATE_CONTRIB)/source_Contribution.txt
TARGET_ALL_CONTRIB=$(DIR_RESULTS_CONTRIB)/all.tiff
TARGET_ALL_INTERMEDIATE_CONTRIB=$(DIR_INTERMEDIATE_CONTRIB)/all.txt
TARGET_ALL_FASTA_CONTRIB=$(DIR_FASTA_CONTRIB)/all.fasta
TARGETS_CONTRIB=$(addprefix $(DIR_RESULTS_CONTRIB)/, $(addsuffix _Contribution.tiff, $(basename $(FILES_CONTRIB))))

.SECONDARY:
.PHONY: contribution
contribution: $(TARGETS_CONTRIB) $(TARGET_ALL_CONTRIB)

$(DIR_RESULTS_CONTRIB)/%.tiff: $(DIR_INTERMEDIATE_CONTRIB)/%.txt $(DIR_SCRIPTS)/Rscripts/PlotRelativeLengthDistribution.R $(TARGET_SOURCE_INTERMEDIATE_CONTRIB)
	Rscript $(DIR_SCRIPTS)/Rscripts/PlotRelativeLengthDistribution.R $< $(TARGET_SOURCE_INTERMEDIATE_CONTRIB) $(basename $@)

$(TARGET_ALL_CONTRIB): $(TARGET_ALL_INTERMEDIATE_CONTRIB) $(TARGET_SOURCE_INTERMEDIATE_CONTRIB) $(DIR_SCRIPTS)/Rscripts/PlotRelativeLengthDistribution.R
	Rscript $(DIR_SCRIPTS)/Rscripts/PlotRelativeLengthDistribution.R $< $(TARGET_SOURCE_INTERMEDIATE_CONTRIB) $(basename $@)

$(TARGET_SOURCE_INTERMEDIATE_CONTRIB): $(FILE_SOURCE_FASTA_CONTRIB) $(DIR_SCRIPTS)/Utility/LengthDistribution.py
	mkdir -p $(DIR_INTERMEDIATE_CONTRIB)
	cat $< | $(DIR_SCRIPTS)/Utility/LengthDistribution.py 60 $(shell head -n1 $(TARGET_COUNT_CONTRIB)) > $@

$(TARGET_ALL_INTERMEDIATE_CONTRIB): $(TARGET_ALL_FASTA_CONTRIB) $(DIR_SCRIPTS)/Utility/LengthDistribution.py
	mkdir -p $(DIR_INTERMEDIATE_CONTRIB)
	cat $< | $(DIR_SCRIPTS)/Utility/LengthDistribution.py 60 $(shell head -n1 $(TARGET_COUNT_CONTRIB)) > $@

$(DIR_INTERMEDIATE_CONTRIB)/%_Contribution.txt: $(DIR_FASTA_CONTRIB)/%.fasta $(DIR_SCRIPTS)/Utility/LengthDistribution.py $(TARGET_COUNT_CONTRIB)
	mkdir -p $(DIR_INTERMEDIATE_CONTRIB)
	cat $< | $(DIR_SCRIPTS)/Utility/LengthDistribution.py 60 $(shell head -n1 $(TARGET_COUNT_CONTRIB)) > $@

$(TARGET_COUNT_CONTRIB): $(FILE_SOURCE_FASTA_CONTRIB)
	grep '>' $< | awk '{ sum+=$$NF } END { print sum }' > $@

$(TARGET_ALL_FASTA_CONTRIB): $(TARGETS_FASTA_CONTRIB) $(DIR_SCRIPTS)/Utility/getFasta.py $(FILE_SOURCE_FASTA_CONTRIB)
	grep '>' $(TARGETS_FASTA_CONTRIB) | awk '{print $$2}' | sort | uniq | $(DIR_SCRIPTS)/Utility/getFasta.py $(FILE_SOURCE_FASTA_CONTRIB) match > $@

$(DIR_FASTA_CONTRIB)/%.fasta: $(DIR_SOURCE_FASTA_CONTRIB)/%.fasta
	mkdir -p $(DIR_FASTA_CONTRIB)
	ln -s ../../$< $@
