# To add with init
#DIR_SCRIPTS=...
#FILES+=...
#FILE_SOURCE_FASTA=...

DIR_SOURCE_FASTA=GenomeMapping/fasta
DIR_RESULTS=ContributionAnalysis
DIR_FASTA=$(DIR_RESULTS)/Fasta
DIR_INTERMEDIATE=$(DIR_RESULTS)/Intermediate

TARGETS_FASTA=$(addprefix $(DIR_FASTA)/, $(FILES))
TARGET_COUNT=$(DIR_RESULTS)/count.txt
TARGETS_INTERMEDIATE=$(addprefix $(DIR_RESULTS)/, $(addsuffix _Contribution.txt, $(basename $(FILES))))
TARGET_SOURCE_INTERMEDIATE=$(DIR_INTERMEDIATE)/source_Contribution.txt
TARGET_ALL=$(DIR_RESULTS)/all.tiff
TARGET_ALL_INTERMEDIATE=$(DIR_INTERMEDIATE)/all.txt
TARGET_ALL_FASTA=$(DIR_FASTA)/all.fasta
TARGETS=$(addprefix $(DIR_RESULTS)/, $(addsuffix _Contribution.tiff, $(basename $(FILES))))

.SECONDARY:
.PHONY: contribution
contribution: $(TARGETS) $(TARGET_ALL)

$(DIR_RESULTS)/%.tiff: $(DIR_INTERMEDIATE)/%.txt $(DIR_SCRIPTS)/Rscripts/PlotRelativeLengthDistribution.R $(TARGET_SOURCE_INTERMEDIATE)
	Rscript $(DIR_SCRIPTS)/Rscripts/PlotRelativeLengthDistribution.R $< $(TARGET_SOURCE_INTERMEDIATE) $(basename $@)

$(TARGET_ALL): $(TARGET_ALL_INTERMEDIATE) $(TARGET_SOURCE_INTERMEDIATE) $(DIR_SCRIPTS)/Rscripts/PlotRelativeLengthDistribution.R
	Rscript $(DIR_SCRIPTS)/Rscripts/PlotRelativeLengthDistribution.R $< $(TARGET_SOURCE_INTERMEDIATE) $(basename $@)

$(TARGET_SOURCE_INTERMEDIATE): $(FILE_SOURCE_FASTA) $(DIR_SCRIPTS)/Utility/LengthDistribution.py
	mkdir -p $(DIR_INTERMEDIATE)
	cat $< | $(DIR_SCRIPTS)/Utility/LengthDistribution.py 60 $(shell head -n1 $(TARGET_COUNT)) > $@

$(TARGET_ALL_INTERMEDIATE): $(TARGET_ALL_FASTA) $(DIR_SCRIPTS)/Utility/LengthDistribution.py
	mkdir -p $(DIR_INTERMEDIATE)
	cat $< | $(DIR_SCRIPTS)/Utility/LengthDistribution.py 60 $(shell head -n1 $(TARGET_COUNT)) > $@

$(DIR_INTERMEDIATE)/%_Contribution.txt: $(DIR_FASTA)/%.fasta $(DIR_SCRIPTS)/Utility/LengthDistribution.py $(TARGET_COUNT)
	mkdir -p $(DIR_INTERMEDIATE)
	cat $< | $(DIR_SCRIPTS)/Utility/LengthDistribution.py 60 $(shell head -n1 $(TARGET_COUNT)) > $@

$(TARGET_COUNT): $(FILE_SOURCE_FASTA)
	grep '>' $< | awk '{ sum+=$$NF } END { print sum }' > $@

$(TARGET_ALL_FASTA): $(TARGETS_FASTA) $(DIR_SCRIPTS)/Utility/getFasta.py $(FILE_SOURCE_FASTA)
	grep '>' $(TARGETS_FASTA) | awk '{print $$2}' | sort | uniq | $(DIR_SCRIPTS)/Utility/getFasta.py $(FILE_SOURCE_FASTA) match > $@

$(DIR_FASTA)/%.fasta: $(DIR_SOURCE_FASTA)/%.fasta
	mkdir -p $(DIR_FASTA)
	ln -s ../../$< $@
