# To add with: Utility/init
# DIR_SCRIPTS=...
# ADAPTOR=...
# FILE_DATA=...

# Declare variables
DIR_FILTERING=RawSequenceFiltering
DIR_STATISTICS=$(DIR_FILTERING)/Statistics
DIR_META=$(DIR_FILTERING)/Meta
DIR_DATA=Data

BASE=$(notdir $(basename $(FILE_DATA)))
FILE_BASE=$(DIR_DATA)/$(BASE).fastq
FILE_TRIM_FASTQ=$(DIR_FILTERING)/$(BASE)_trimmed.fastq
FILE_TRIM_FASTA=$(DIR_FILTERING)/$(BASE)_trimmed.fasta
FILE_TRIM_STATS=$(DIR_STATISTICS)/TrimmingStats.txt

SCRIPT_ADAPTOR=$(DIR_SCRIPTS)/Utility/AdaptorFinder.py
SCRIPT_QUALITY=$(DIR_SCRIPTS)/Utility/QualityFilter.py
SCRIPT_DUPLICATE=$(DIR_SCRIPTS)/Utility/DuplicateMerger.py
SCRIPT_FASTQ_STATS=$(DIR_SCRIPTS)/Utility/FastqStats.py
SCRIPT_FASTA_STATS=$(DIR_SCRIPTS)/Utility/FastaStats.py

# Build directory structure
$(shell mkdir -p $(DIR_META))
$(shell mkdir -p $(DIR_STATISTICS))

# Start Analysis
.PHONY: filtering
filtering: $(FILE_TRIM_FASTA) $(FILE_TRIM_FASTQ)

$(FILE_TRIM_FASTA): $(FILE_TRIM_FASTQ) $(SCRIPT_DUPLICATE) $(SCRIPT_FASTA_STATS)
	cat $< | $(SCRIPT_DUPLICATE) 4 | $(SCRIPT_FASTA_STATS) $(FILE_TRIM_STATS) "After collapsing duplicated sequences" > $@
	$(SCRIPT_DUPLICATE) version >> $(DIR_META)/Trimming.txt
	$(SCRIPT_FASTA_STATS) version >> $(DIR_META)/Trimming.txt

$(FILE_TRIM_FASTQ): $(FILE_BASE) $(SCRIPT_ADAPTOR) $(SCRIPT_QUALITY) $(SCRIPT_FASTQ_STATS)
	rm -f $(FILE_TRIM_STATS)
	cat $< | $(SCRIPT_FASTQ_STATS) $(FILE_TRIM_STATS) "Before trimming" \
	| $(SCRIPT_ADAPTOR) $(ADAPTOR) 3 2 | $(SCRIPT_FASTQ_STATS) $(FILE_TRIM_STATS) "After removing adaptors" \
	| $(SCRIPT_QUALITY) 9 | $(SCRIPT_FASTQ_STATS) $(FILE_TRIM_STATS) "After quality filtering" \
	> $@
	$(SCRIPT_ADAPTOR) version > $(DIR_META)/Trimming.txt
	$(SCRIPT_QUALITY) version >> $(DIR_META)/Trimming.txt
	$(SCRIPT_FASTQ_STATS) version >> $(DIR_META)/Trimming.txt

$(FILE_BASE): $(FILE_DATA)
	mkdir -p $(DIR_DATA)
	ln -s ../$< $@
