# To add with init
#DIR_SCRIPTS=...
#BASE_FILES_OTHER+=...
#DIR_FASTQ_OTHER=...
#DIR_SOURCE_REFERENCE_OTHER=...
#BASE_FASTQ_OTHER=...
#BASE_OUTPUT_OTHER=...
#FILE_FASTA_OTHER-...

# Prepare variables
DIR_MAPPING=GenomeMapping
DIR_BAM=$(DIR_MAPPING)/bam
DIR_FASTA=$(DIR_MAPPING)/fasta
DIR_REFERENCE_OTHER=reference-others

FILE_FASTQ_OTHER=$(DIR_FASTQ_OTHER)/$(BASE_FASTQ_OTHER)
FILE_IMAGE=GenomeMapping/mapping.tiff
FILE_SUMMARY=GenomeMapping/summary.txt

TOOL_SAMTOOLS=$(shell which samtools)

TARGETS_BAM_OTHER=$(addprefix $(DIR_BAM)/, $(addsuffix .bam, $(BASE_FILES_OTHER)))
TARGETS_FASTA_OTHER=$(addprefix $(DIR_FASTA)/, $(addsuffix .fasta, $(BASE_FILES_OTHER)))

# Prepare Directory Structure
$(shell mkdir -p $(DIR_BAM))

# Alignment
.SECONDARY:

.PHONY: mapping-others
mapping-others: $(TARGETS_FASTA_OTHER) $(FILE_IMAGE)

$(DIR_FASTA)/%.fasta: $(DIR_BAM)/%.bam $(FILE_FASTA_OTHER)
	mkdir -p $(DIR_FASTA)
	$(TOOL_SAMTOOLS) view -F4 $< | grep 'NM:i:0\|NM:i:1\|NM:i:2\|NM:i:3' | cut -f1 | $(DIR_SCRIPTS)/Utility/getFasta.py $(FILE_FASTA_OTHER) not-match > $@
#	$(TOOL_SAMTOOLS) view -F4 $< | grep 'NM:i:0' | cut -f1 | $(DIR_SCRIPTS)/Utility/getFasta.py $(FILE_FASTA_OTHER) match > $@

$(DIR_BAM)/%.bam: $(DIR_MAPPING)/$(FILE_FASTQ_OTHER) $(DIR_REFERENCE_OTHER)/%.fasta
	mkdir -p $(DIR_MAPPING)/$(basename $(notdir $@))
	cd $(DIR_MAPPING)/$(basename $(notdir $@)); $(DIR_SCRIPTS)/Alignment-Tools/Alignment-Tools init bwa-aln ../$(FILE_FASTQ_OTHER) ../../$(DIR_REFERENCE_OTHER)/$(basename $(notdir $(@:_trimmed.bam=))).fasta "-n;3;-o;0;-d;0;-i;0"
	$(MAKE) -C $(DIR_MAPPING)/$(basename $(notdir $@))
	ln -sf ../$(basename $(notdir $@))/$(basename $(notdir $(BASE_FASTQ_OTHER))).bam $@

$(DIR_REFERENCE_OTHER)/%.fasta: $(DIR_SOURCE_REFERENCE_OTHER)/%.fa
	cat $< | $(DIR_SCRIPTS)/Utility/convertRNAfastaToDNA.py > $@

$(FILE_IMAGE): $(FILE_SUMMARY)
	Rscript $(DIR_SCRIPTS)/Rscripts/GenomeMapping.R $(FILE_SUMMARY) $@

$(FILE_SUMMARY): $(TARGETS_BAM_OTHER) $(TARGET_FASTA_OTHER)
	echo -e "RNA_specie	Count" > $(FILE_SUMMARY)
	$(DIR_SCRIPTS)/Utility/summarize_mapping.sh | sort -nr -k2 >> $(FILE_SUMMARY)
